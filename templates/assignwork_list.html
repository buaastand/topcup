<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>科技竞赛平台</title>
    <!-- 引入vue.js,axios.js -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.staticfile.org/vue-resource/1.5.1/vue-resource.min.js"></script>

    <!-- 引入element.ui-->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>

    <!-- 引入css-->
    <link rel="stylesheet" href="../static/css/NavName.css">
    <link rel="stylesheet" href="../static/css/assignwork_list.css" type="text/css">
</head>

<body style="margin: 0; background: #F5F7FA">
    {% include 'NavMenu.html' %} 
    
    <div id="AssignworkList" style="width: 100%">
        <div class="buttonArea">
            <el-button type="primary" @click="selectExpert">为选中的作品分配专家</el-button>
        </div>

        <div class="tableArea">
            <el-table
                ref="multipleTable"
                :data="workTableData"
                tooltip-effect="dark"
                style="width: 1000px;"
                @selection-change="whandleSelectionChange">
                <el-table-column
                    type="selection"
                    width="40">
                </el-table-column>
                <el-table-column
                    type="index"
                    label="序号"
                    width="60">
                </el-table-column>
                <el-table-column
                    label="作品ID"
                    prop="work_id"
                    width="120">
                </el-table-column>
                <el-table-column
                    label="作品名称"
                    prop="title"
                    width="400">
                </el-table-column>
                <el-table-column
                    label="作品类别"
                    prop="work_type"
                    :filters="typeFilters"
                    :filter-method="filterHandler"
                    width="200">
                </el-table-column>
                <el-table-column
                    label="作品领域"
                    prop="field"
                    :filters="fieldFilters"
                    :filter-method="filterHandler"
                    show-overflow-tooltip>
                </el-table-column>
          </el-table>
        </div>

        <el-dialog
            title="可选专家"
            :visible.sync="dialogVisible"
            width="800"
            :before-close="handleClose">
            <span>
                <el-table ref="multipleTable" 
                    :data="expertTableData" 
                    tooltip-effect="dark" 
                    style="width: 1000px;"
                    @selection-change="ehandleSelectionChange">
                    <el-table-column type="selection" width="40">
                    </el-table-column>
                    <el-table-column type="index" label="序号" width="60">
                    </el-table-column>
                    <el-table-column class-name="expert_id" label="" prop="expert_id" width="0">
                    </el-table-column>
                    <el-table-column label="专家姓名" prop="name" width="120">
                    </el-table-column>
                    <el-table-column label="专家领域" prop="field" width="200">
                    </el-table-column>
                    <el-table-column label="专家邮箱" prop="email" show-overflow-tooltip>
                    </el-table-column>
                </el-table>
            </span>
        <span slot="footer" class="dialog-footer">
            <el-button @click="dialogVisible = false">取消</el-button>
            <el-button type="primary" @click="matchWorksAndExperts">确认分配</el-button>
        </span>
        </el-dialog>
    </div>

    <script>
        var assList = new Vue({
            el: '#AssignworkList',
            data: {
                dialogVisible: false,
                workTableData: {{ worklist | safe }},
                expertTableData: {{ expertlist | safe }},
                wmultipleSelection: [],
                emultipleSelection: [],
                typeFilters: [{ text: '科技发明制作', value: '科技发明制作' }, 
                    { text: '调查报告和学术论文', value: '调查报告和学术论文' }],
                fieldFilters: [{ text: 'A', value: 'A' }, { text: 'B', value: 'B' }, 
                    { text: 'C', value: 'C' }, { text: 'D', value: 'D' }, 
                    { text: 'E', value: 'E' }, { text: 'F', value: 'F' }]
            },
            methods: {
                wtoggleSelection(rows) {
                    if (rows) {
                        rows.forEach(row => {
                            this.$refs.wmultipleTable.toggleRowSelection(row);
                        });
                    } else {
                        this.$refs.wmultipleTable.clearSelection();
                    }
                },
                whandleSelectionChange(val) {
                    this.wmultipleSelection = val;
                    // console.log(this.wmultipleSelection["0"]['work_id']);
                },
                etoggleSelection(rows) {
                    if (rows) {
                        rows.forEach(row => {
                            this.$refs.emultipleTable.toggleRowSelection(row);
                        });
                    } else {
                        this.$refs.emultipleTable.clearSelection();
                    }
                },
                ehandleSelectionChange(val) {
                    this.emultipleSelection = val;
                },
                filterHandler(value, row, column) {
                    const property = column['property'];
                    return row[property] === value;
                },
                selectExpert() {
                    if (this.wmultipleSelection.length > 0) {
                        this.dialogVisible = true;
                    }
                    else{
                        this.$message.error('请至少选择一个参赛作品！');
                    }
                },
                handleClose(done) {
                    this.$confirm('确认关闭？')
                    .then(_ => {
                        done();
                    })
                    .catch(_ => {});
                },
                matchWorksAndExperts(){
                    var em_length = this.emultipleSelection.length;
                    if (em_length < 3) {
                        this.$message.error('请至少选择三名专家！');
                        return;
                    }

                    var wm_length = this.wmultipleSelection.length;
                    selected_work = [];
                    selected_expert = [];

                    for (var i=0; i < wm_length; i++) {
                        selected_work.push(this.wmultipleSelection[i]['work_id'])
                    }
                    for (var i=0; i < em_length; i++) {
                        selected_expert.push(this.emultipleSelection[i]['expert_id'])
                    }
                    console.log(selected_work);
                    console.log(selected_expert);
                    
                    axios
                    .post('',{
                        selected_work: selected_work,
                        selected_expert: expert_id,
                    })
                    .then(response => {console.log(response)})
                    .catch(function (error) { // 请求失败处理
                        console.log(error);
                        this.$message.error('分配失败！');
                        this.dialogVisible = false;
                    });
                }
            },
            delimiters: ["{[", "]}"]
        });
        // console.log(assList.expertTableData);
    </script>
</body>

</html>